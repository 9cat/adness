<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bitcoin Talk Ad Auction</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- build:css styles/vendor.css -->
    <!-- bower:css -->
    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.css" />
    <!-- endbower -->
    <!-- endbuild -->
    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/pickadate/compressed/themes/default.css">
    <link rel="stylesheet" href="/css/pickadate/compressed/themes/default.date.css">
    <link rel="stylesheet" href="/css/pickadate/compressed/themes/default.time.css">
    <!-- endbuild -->
  </head>
  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

    <!-- Page Start -->
    <div class="main">
      <!-- sidebar -->
      <div class="sidebar">
        <!-- Logo -->
        <div class="row logo">
          Adness
        </div>

        <!-- Links to other pages -->
        <a href="/admin">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-tasks icon-large"></span><br>
            Admin
          </div>
        </a> 
        <a href="<%= browsePrefix %>">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-home icon-large"></span><br>
            Home
          </div>
        </a> 
        <a href="<%= browsePrefix %>/profile">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-user icon-large"></span><br>
            Profile
          </div>
        </a> 
        <a href="<%= browsePrefix %>/ads">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-list icon-large"></span><br>
            My Ads
          </div>
        </a> 
        <a href="<%= browsePrefix %>/history">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-list-alt icon-large"></span><br>
            History
          </div>
        </a>
      </div>

      <div class="main-container">
        <!-- Header -->
        <div class="row">
          <div class="col-sm-12 header">
            <div class="container-fluid bootstrap-fluid-fix">
              <div class="row">
                <!-- Forum Rules Button -->
                <div class="col-sm-1">
                  <button data-toggle="modal" data-target="#forumRulesModal" class="btn btn-primary">Rules</button>
                </div>

                <!-- Login module -->
                <div class="col-sm-11">
                  <% if (user) { %>
                  <div>
                    Logged In: <%= user.username %>
                    <a href="/logout">Logout</a>
                  </div>
                  <% } else { %>
                  <form class="form-inline pull-right" role="form" method="post" action="/login">
                    <div class="form-group">
                      <!-- <span>{{message}}</span> -->
                    </div>
                    <div class="form-group">
                      <input name="username" type="username" class="form-control" placeholder="Username">
                    </div>
                    <div class="form-group">
                      <input name="password" type="password" class="form-control" placeholder="Password">
                    </div>
                    <button type="submit" class="btn btn-default">Log In</button>
                    <a class="btn btn-default" href="<%= browsePrefix %>/registration">Registration</a>
                  </form>
                  <% } %>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Main Content -->
        <div class="row">          
          <%- body %>
        </div>
      </div>
    </div>

    <!-- Ad Auction Rules Modal -->
    <div id="forumRulesModal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title">Ad Auction Rules</h4>
          </div>

          <div class="modal-body">
            <p>
              The forum sells ad space in the area beneath the first post of every topic page. About 25% of ad income goes to the forum moderators as thanks for all of their work. (There are many moderators, so each moderator gets only a small amount -- moderators should be seen as volunteers, not employees.) The rest is stored in the forum's treasury (verifiably), where it sits until the forum needs it.
            </p>

            <p>
              Ads are allowed to contain any non-annoying HTML/CSS style. No images, JavaScript, or animation (no marquee or blinking). Ads must appear 3 or fewer lines tall in my browser (Firefox, 700px wide). Ad text may not contain lies, misrepresentation, or inappropriate language. Ads may not link directly to any NSFW page. Ads may be rejected for other reasons.
            </p>

            <p>
              There are 10 total ad slots which are randomly rotated. So one ad slot has a one in ten chance of appearing. Eight of the slots are for sale here. Ads appear only on topic pages with more than one post, and only for people using the default theme.
            </p>

            <p>
              The ad lasts at least 7 days starting from when I put it up. (However, if you look at the ad history you'll see that ads frequently get 1-2 extra days, but this is random and definitely not guaranteed.)
            </p>

            <br>
            <p><b>Stats</b></p>

            <p>
              Exact historical impression counts per slot:
              <a href="https://bitcointalk.org/adrotate.php?adstats">
                https://bitcointalk.org/adrotate.php?adstats
              </a>
            </p>

            <p>
              Info about the current ad slots:
              <a href="https://bitcointalk.org/adrotate.php?adinfo">
                https://bitcointalk.org/adrotate.php?adinfo
              </a>
            </p>

            <br>
            <p><b>Ad blocking</b></p>

            <p>
              Hero members, Donators, VIPs, and moderators have the ability to disable ads. I don't expect many people to use this option. These people don't increase the impression counts for your ads.
            </p>

            <p>
              I try to bypass Adblock Plus filters as much as possible, though this is not guaranteed. It is difficult or impossible for ABP filters to block the ad space itself without blocking posts. However, filters can match against the URLs in your links, your CSS classes and style attributes, and the HTML structure of your ads.
            </p>

            <p>
              To prevent matches against URLs: I have some JavaScript which fixes links blocked by ABP. You must tell me if you want this for your ads. When someone with ABP and JavaScript enabled views your ads, your links are changed to a special randomized bitcointalk.org URL which redirects to your site when visited. People without ABP are unaffected, even if they don't have JavaScript enabled. The downsides are:
              <ul>
                <li>
                  ABP users will see the redirection link when they hover over the link, even if they disable ABP for the forum.
                </li>
                <li>
                  Getting referral stats might become even more difficult.
                </li>
                <li>
                  Some users might get a warning when redirecting from https to http.
                </li>
              </ul>
            </p>

            <p>
              To prevent matching on CSS classes/styles: Don't use inline CSS. I can give your ad a CSS class that is randomized on each pageload, but you must request this.
            </p>

            <p>
              To prevent matching against your HTML structure: Use only one <code>&lt;a&gt;</code> and no other tags if possible. If your ads get blocked because of matching done on something inside of your ad, you are responsible for noticing this and giving me new ad HTML.
            </p>

            <br>
            <p><b>Auction rules</b></p>

            <p>
              Post your bids in this thread. Prices must be stated in BTC per slot. You must make a bid for each slot you want. When the auction ends, the highest bidders will have their slots filled until all eight slots are filled.
            </p>

            <p>
              I reserve the right to reject bids, even days after the bid is made. In particular, bids from people with less than 15 activity points are likely to be rejected. I recommend not getting into a bidding war with someone who has less than 15 activity points, as their bids might not be accepted, but your latest bids will still stand. If you need to know right away whether someone's bids will be accepted, PM me.
            </p>

            <ul>
              <li>
                All bid prices must be evenly divisible by 0.05.
              </li>
              <li>
                The bidding starts at 0.50.
              </li>
              <li>
                I will end the auction at an arbitrary time on the day the auction is slated to end. (I will probably end the auction 1-3 days before the ads are scheduled to go up.)
              </li>
            </ul>

            <p>
              If these rules are confusing, look at some of the past forum ad auctions to see how it's done.
            </p>

            <p>
              You must pay for your slots within 24 hours of receiving the payment address. Otherwise your slots may be sold to someone else.
            </p>
          </div>
          
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">
              Close
            </button>
          </div>

        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID -->
    <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

       ga('create', 'UA-XXXXX-X');
       ga('send', 'pageview');
    </script>

    <!--[if lt IE 9]>
    <script src="bower_components/es5-shim/es5-shim.js"></script>
    <script src="bower_components/json3/lib/json3.min.js"></script>
    <![endif]-->

    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="/scripts/jquery/jquery-2.1.0.min.js"></script>
    <script src="/css/bootstrap/js/bootstrap.js"></script>
    <script src="/scripts/pickadate/legacy.js"></script>
    <script src="/scripts/pickadate/picker.js"></script>
    <script src="/scripts/pickadate/picker.date.js"></script>
    <script src="/scripts/pickadate/picker.time.js"></script>
    <script type="text/javascript">
      var $startDate, $startTime, $endDate, $endTime;

      // initialize the pickadate ui
      $(document).ready(function() {
        $startDate = $("#startDate").pickadate({
          min: new Date(),
          format: 'yyyy-m-d',
          editable: true
        });
        $startTime = $("#startTime").pickatime({
          interval: 5, 
          editable: true
        });
        $endDate = $("#endDate").pickadate({
          min: new Date(),
          format: 'yyyy-m-d',
          editable: true
        });
        $endTime = $("#endTime").pickatime({
          interval: 5, 
          editable: true
        });

        // default date in input
        var defaultStart = new Date();
        defaultStart.setDate(defaultStart.getDate()+1);
        defaultStart.setHours(0);
        defaultStart.setMinutes(0);
        defaultStart.setSeconds(0);
        defaultStart.setMilliseconds(0);
        var startDatePicker = $startDate.pickadate('picker');
        var startTimePicker = $startTime.pickatime('picker');
        startDatePicker.set('select', defaultStart);
        startTimePicker.set('select', defaultStart);

        var defaultEnd = new Date();
        defaultEnd.setDate(defaultEnd.getDate() +3);
        defaultEnd.setHours(0);
        defaultEnd.setMinutes(0);
        defaultEnd.setSeconds(0);
        defaultEnd.setMilliseconds(0);
        var endDatePicker = $endDate.pickadate('picker');
        var endTimePicker = $endTime.pickatime('picker');
        endDatePicker.set('select', defaultEnd);
        endTimePicker.set('select', defaultEnd);
      });

      function submitAuction(event) {
        // Initial input validation
        var datePicker = $startDate.pickadate('picker');
        var startDateInput = datePicker.get();
        if (!startDateInput || startDateInput.length === 0) {
          alert("The Start Date is not filled out.");
          return;
        }

        var timePicker = $startTime.pickatime('picker');
        var startTimeInput = timePicker.get();
        if (!startTimeInput || startTimeInput.length === 0) {
          alert("The Start Time is not filled out.");
          return;
        }

        var datePicker = $endDate.pickadate('picker');
        var endDateInput = datePicker.get();
        if (!endDateInput || endDateInput.length === 0) {
          alert("The End Date is not filled out.");
          return;
        }

        var timePicker = $endTime.pickatime('picker');
        var endTimeInput = timePicker.get();
        if (!endTimeInput || endTimeInput.length === 0) {
          alert("The End Time is not filled out.");
          return;
        }

        var start = buildDateTime(startDateInput, startTimeInput);
        var end = buildDateTime(endDateInput, endTimeInput);
        var slots = $('#slots').val();

        // validate startDate, endDate and slots
        var startValid = !isNaN(parseFloat(start)) && isFinite(start);
        if (startValid === false) {
          alert("The Start date/time is not valid.");
          return;
        }

        var endValid = !isNaN(parseFloat(end)) && isFinite(end);
        if (endValid === false) {
          alert("The End date/time is not valid.");
          return;
        }

        if (end < start) {
          alert("The End date/time is before Start date/time.");
          return;
        }

        var current = new Date().getTime();
        // minus five minutes for user input
        current = current - (1000 * 60 * 5);
        if (current > start) {
          alert("Start Date/Time cannot be in the past");
          return;
        }
        if (current > end) {
          alert("End Date/Time cannot be in the past");
          return;
        }

        var slotsValid = !isNaN(parseFloat(slots)) && isFinite(slots);
        if (slotsValid === false) {
          alert("The number of slots is not valid.");
          return;
        }

        // ajax post call to server to create auction
        $.ajax({ 
          type: "POST", 
          url: '/sb/auction', 
          data: {
            start: start, 
            end: end,
            slots: slots
          }, 
          success: function() {
            location.reload();
          },
          error: function() {
            alert("There was an error creating the auction.");
          }          
        });
      }

      function buildDateTime(date, time) {
        // get the date, format yyyy-mm-dd
        var year = date.split("-")[0];
        var month = date.split("-")[1];
        var day = date.split("-")[2];

        // get the time, format HH:MM (AM/PM)
        var hours = Number(time.split(":")[0]); // hours from [12]:00 AM
        var timeSplit = time.split(":")[1]; // split second half 12:[00 AM]
        var mins = 0;
        if (timeSplit) { mins = timeSplit.split(" ")[0]; } // mins 12:[00] AM
        if (timeSplit) {
          var period = timeSplit.split(" ")[1]; // period 12:00 [AM]
          if (period && period.toUpperCase() === "PM") {
            hours = hours + 12;
            if (hours === 24) { hours = 12; } 
          }
          else if (period && period.toUpperCase() === "AM") {
            // if no period, assume first 12 hours
            // so do nothing
          }
          else {
            return "";
          }
        }

        // parse datetime into millisecs
        var datetime = new Date();
        datetime.setFullYear(Number(year));
        datetime.setMonth(Number(month) -1, Number(day));
        datetime.setHours(Number(hours), Number(mins));
        return datetime.getTime();
      }
    </script>
    <!-- endbower -->
    <!-- endbuild -->
</body>
</html>
