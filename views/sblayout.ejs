<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bitcoin Talk Ad Auction</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- build:css styles/vendor.css -->
    <!-- bower:css -->
    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.css" />
    <!-- endbower -->
    <!-- endbuild -->
    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/datetimepicker/bootstrap-datetimepicker.css">
    <!-- endbuild -->
  </head>
  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

    <!-- Page Start -->
    <div class="main">
      <!-- sidebar -->
      <div class="sidebar hidden-xs">
        <!-- Logo -->
        <div class="row logo">
          Adness
        </div>

        <!-- Links to other pages -->
        <% if (user && user.admin && user.admin === true) { %>
          <a href="/admin">
            <div class="sidebar-button">
              <span class="glyphicon glyphicon-wrench icon-large"></span><br>
              Admin
            </div>
          </a>
        <% } %>
        <a href="<%= browsePrefix %>">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-home icon-large"></span><br>
            Home
          </div>
        </a>
        <a href="<%= browsePrefix %>/rules">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-list-alt icon-large"></span><br>
            Rules
          </div>
        </a>
        <% if (user && user.username) { %>
          <a href="<%= browsePrefix %>/users/<%= user.userId %>">
            <div class="sidebar-button">
              <span class="glyphicon glyphicon-user icon-large"></span><br>
              Profile
            </div>
          </a>
        <% } %>
        <a href="<%= browsePrefix %>/history">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-bookmark icon-large"></span><br>
            History
          </div>
        </a>
      </div>

      <div class="main-container">
        <!-- mobile ready header -->
        <div class="row">
          <nav id="header" class="navbar navbar-default" role="navigation">
            <div class="container-fluid">

              <!-- Brand and toggle get grouped for better mobile display -->
              <div class="navbar-header">
                <% if (user) { %>
                  <div class="header-logout-message">
                    Logged In: <%= user.username %>
                  </div>
                <% } %>

                <!-- pull down login -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-login">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>

                <!-- drop down sidebar -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-sidenav" id="mobile-menu-btn">
                  Menu
                </button>
              </div>

              <!-- sidebar nav in header -->
              <div class="collapse" id="header-sidenav">
                <ul class="nav navbar-nav nav-justified">
                  <% if (user && user.admin && user.admin === true) { %>
                    <li><a href="/admin" class="navbar-link">Admin</a></li>
                  <% } %>
                  <li><a href="<%= browsePrefix %>" class="navbar-link">Home</a></li>
                  <li><a href="<%= browsePrefix %>/rules">Rules</a></li>
                  <% if (user && user.username) { %>
                    <li>
                      <a href="<%= browsePrefix %>/users/<%= user.userId %>">
                        Profile
                      </a>
                    </li>
                  <% } %>
                  <li><a href="<%= browsePrefix %>/history">History</a></li>
                </ul>
              </div><!-- /.navbar-collapse -->

              <!-- Collect the nav links, forms, and other content for toggling -->
              <div class="collapse navbar-collapse" id="header-login">
                <% if (user) { %>
                  <div class="header-logout-container-wide">
                    <a href="/logout" class="btn btn-primary">Logout</a>
                    <div class="header-logout-menu-message">
                      Logged In: <%= user.username %>
                    </div>
                  </div>
                <% } else { %>
                  <form class="form-inline" role="form" method="post" action="/login">
                    <div class="form-group">
                      <input name="username" type="username" class="form-control" placeholder="Username">
                    </div>
                    <div class="form-group">
                      <input name="password" type="password" class="form-control" placeholder="Password">
                    </div>
                    <button type="submit" class="btn btn-default">Log In</button>
                  </form>
                <% } %>
              </div><!-- /.navbar-collapse -->

            </div><!-- /.container-fluid -->
          </nav>
        </div>

        <!-- Main Content -->
        <div class="row">
          <%- body %>
        </div>
      </div>
    </div>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID -->
    <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

       ga('create', 'UA-XXXXX-X');
       ga('send', 'pageview');
    </script>

    <!--[if lt IE 9]>
    <script src="bower_components/es5-shim/es5-shim.js"></script>
    <script src="bower_components/json3/lib/json3.min.js"></script>
    <![endif]-->

    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="/scripts/jquery/jquery-2.1.0.min.js"></script>
    <script src="/scripts/momentjs/moment.min.js"></script>
    <script src="/css/bootstrap/js/bootstrap.js"></script>
    <script src="/scripts/datetimepicker/bootstrap-datetimepicker.min.js"></script>
    <script src="/scripts/caja/html-sanitizer-minified.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        // initialize the datetimepicker ui
        $('#auctionStart').datetimepicker({ useStrict: true, sideBySide: true });
        $('#auctionEnd').datetimepicker({ useStrict: true, sideBySide: true });
        $('#adsStart').datetimepicker({ useStrict: true, sideBySide: true });
        $('#adsEnd').datetimepicker({ useStrict: true, sideBySide: true });

        // set date time picker values
        if (document.URL.indexOf("/admin/auctions/edit") >= 0) {
          var auctionStart = $('#hiddenAuctionStart').val();
          var auctionEnd = $('#hiddenAuctionEnd').val();
          var adsStart = $('#hiddenAdsStart').val();
          var adsEnd = $('#hiddenAdsEnd').val();
          setDateTime(auctionStart, auctionEnd, adsStart, adsEnd);
        }
        else if (document.URL.indexOf("/admin") >= 0) {
          setDateTime();
        }
      });

      function addRegion() {
        // get all existing regions
        var regions = gatherRegions();

        // check that region isn't already used
        var regionName = $('#auctionRegion').val();
        var matchFound = false;
        regions.forEach(function(region) {
          if (region.name === regionName) {
            matchFound = true;
          }
        });
        if (matchFound) {
          $('#errorText').text(regionName + ' is already included.');
          return;
        }

        // check that slots is a valid number
        var slots = $('#slots').val();
        var slotsIsNumber = !isNaN(parseFloat(slots)) && isFinite(slots);
        if (!slotsIsNumber) {
          $('#errorText').text('Slots must be a number');
          return;
        }

        if (slotsIsNumber && slots < 1) {
          $('#errorText').text('Slots cannot be negative or zero');
          return;
        }

        // add region to the table to the table
        var html = '<tr><td>';
        html += regionName;
        html += '</td><td>';
        html += slots;
        html += '</td>';
        html += '<td class="text-center">';
        html += '<button class="btn btn-xs btn-danger" onclick="removeRegion(this);">';
        html += '<span class="glyphicon glyphicon-remove"></span></button></td>';
        html += '</tr>';
        $('#regionsTable tbody').append(html);
      }

      function removeRegion(element) {
        var parentRow = $(element).closest('tr');
        parentRow.remove();
      }

      function gatherRegions() {
        var regions = [];

        // get all row in the regions table
        $('#regionsTable tbody tr').each(function(index, value) {
          var regionName = $(this).find('td:nth-child(1)').text();
          var slots = Number($(this).find('td:nth-child(2)').text());

          // build region json object
          var region = { name: regionName, slots: slots };
          regions.push(region);
        });

        return regions;
      }

      function updateAuction(id, enabled) {
        // input validation
        var valid = auctionValidation();
        if(!valid) { return; }

        // grab auction enabled
        var id = $('#auctionId').val();
        var enabled = $("#auctionEnabled").prop("checked");

        // grab region
        var regions = gatherRegions();
        var regionsValid = validateRegions(regions);
        if (!regionsValid) { return; }

        // ajax post call to server to create auction
        $.ajax({
          type: "POST",
          url: '<%= browsePrefix %>/auctions/edit',
          data: {
            auctionId: id,
            start: valid.auctionStart,
            end: valid.auctionEnd,
            adsStart: valid.adsStart,
            adsEnd: valid.adsEnd,
            description: valid.description,
            regions: regions,
            enabled: enabled
          },
          success: function() {
            window.location.replace("http://" + window.location.host + "/admin");
          },
          error: function() {
            alert("There was an error updating the auction.");
          }
        });
      }

      function setDateTime(auctionStart, auctionEnd, adsStart, adsEnd) {
        if (auctionStart && auctionEnd && adsStart && adsEnd) {
          var newAuctionStart = moment.utc(Number(auctionStart));
          $('#auctionStart').data('DateTimePicker').setDate(newAuctionStart);

          var newAuctionEnd = moment.utc(Number(auctionEnd));
          $('#auctionEnd').data('DateTimePicker').setDate(newAuctionEnd);

          var newAdsStart = moment.utc(Number(adsStart));
          $('#adsStart').data('DateTimePicker').setDate(newAdsStart);

          var newAdsEnd = moment.utc(Number(adsEnd));
          $('#adsEnd').data('DateTimePicker').setDate(newAdsEnd);
        }
        else {
          // auction start is one day ahead midnight
          var defaultAuctionStart = moment.utc();
          defaultAuctionStart.date(defaultAuctionStart.date()+1);
          defaultAuctionStart.hours(0);
          defaultAuctionStart.minutes(0);
          defaultAuctionStart.seconds(0);
          defaultAuctionStart.milliseconds(0);
          $('#auctionStart').data('DateTimePicker').setDate(defaultAuctionStart);

          // auction end is three days ahead midnight
          var defaultAuctionEnd = moment.utc();
          defaultAuctionEnd.date(defaultAuctionEnd.date()+3);
          defaultAuctionEnd.hours(0);
          defaultAuctionEnd.minutes(0);
          defaultAuctionEnd.seconds(0);
          defaultAuctionEnd.milliseconds(0);
          $('#auctionEnd').data('DateTimePicker').setDate(defaultAuctionEnd);

          // ads start is two days ahead midnight of auction end 
          var defaultAdsStart = moment.utc();
          defaultAdsStart.date(defaultAdsStart.date()+5);
          defaultAdsStart.hours(0);
          defaultAdsStart.minutes(0);
          defaultAdsStart.seconds(0);
          defaultAdsStart.milliseconds(0);
          $('#adsStart').data('DateTimePicker').setDate(defaultAdsStart);

          // ads end is seven days ahead midnight of adsStart
          var defaultAdsEnd = moment.utc();
          defaultAdsEnd.date(defaultAdsEnd.date()+12);
          defaultAdsEnd.hours(0);
          defaultAdsEnd.minutes(0);
          defaultAdsEnd.seconds(0);
          defaultAdsEnd.milliseconds(0);
          $('#adsEnd').data('DateTimePicker').setDate(defaultAdsEnd);
        }
      }

      function auctionValidation() {
        // Initial input validation
        var auctionStart;
        var auctionStartDate = $('#auctionStart').data('DateTimePicker').getDate();
        // auctionStartDate is in local timezone so convert to UTC
        if (auctionStartDate) { 
          auctionStart = moment.utc();
          auctionStart.year(auctionStartDate.year());
          auctionStart.month(auctionStartDate.month());
          auctionStart.date(auctionStartDate.date());
          auctionStart.hours(auctionStartDate.hours());
          auctionStart.minutes(auctionStartDate.minutes());
          auctionStart.seconds(auctionStartDate.seconds());
          auctionStart.milliseconds(auctionStartDate.milliseconds());
          auctionStart = auctionStart.valueOf();
        }
        else { return alert("Auction Start Date/Time doesn't look right."); }

        var auctionEnd; 
        var auctionEndDate = $('#auctionEnd').data('DateTimePicker').getDate();
        // auctionEndDate is in local timezone so convert to UTC
        if (auctionEndDate) {
          auctionEnd = moment.utc();
          auctionEnd.year(auctionEndDate.year());
          auctionEnd.month(auctionEndDate.month());
          auctionEnd.date(auctionEndDate.date());
          auctionEnd.hours(auctionEndDate.hours());
          auctionEnd.minutes(auctionEndDate.minutes());
          auctionEnd.seconds(auctionEndDate.seconds());
          auctionEnd.milliseconds(auctionEndDate.milliseconds());
          auctionEnd = auctionEnd.valueOf();
        }
        else { return alert("Auction End Date/Time doesn't look right."); }

        var adsStart;
        var adsStartDate = $('#adsStart').data('DateTimePicker').getDate();
        // adsStartDate is in local timezone so convert to UTC
        if (adsStartDate) { 
          adsStart = moment.utc();
          adsStart.year(adsStartDate.year());
          adsStart.month(adsStartDate.month());
          adsStart.date(adsStartDate.date());
          adsStart.hours(adsStartDate.hours());
          adsStart.minutes(adsStartDate.minutes());
          adsStart.seconds(adsStartDate.seconds());
          adsStart.milliseconds(adsStartDate.milliseconds());
          adsStart = adsStart.valueOf();
        }
        else { return alert("Ads Start Date/Time doesn't look right."); }

        var adsEnd; 
        var adsEndDate = $('#adsEnd').data('DateTimePicker').getDate();
        // adsEndDate is in local timezone so convert to UTC
        if (adsEndDate) {
          adsEnd = moment.utc();
          adsEnd.year(adsEndDate.year());
          adsEnd.month(adsEndDate.month());
          adsEnd.date(adsEndDate.date());
          adsEnd.hours(adsEndDate.hours());
          adsEnd.minutes(adsEndDate.minutes());
          adsEnd.seconds(adsEndDate.seconds());
          adsEnd.milliseconds(adsEndDate.milliseconds());
          adsEnd = adsEnd.valueOf();
        }
        else { return alert("Ads End Date/Time doesn't look right."); }

        // check that auction start datetime is valid
        var auctionStartValid = !isNaN(parseFloat(auctionStart)) && isFinite(auctionStart);
        if (auctionStartValid === false) {
          alert("The Auction Start date/time is not valid.");
          return false;
        }

        // check that auction end datetime is valid
        var auctionEndValid = !isNaN(parseFloat(auctionEnd)) && isFinite(auctionEnd);
        if (auctionEndValid === false) {
          alert("The Auction End date/time is not valid.");
          return false;
        }

        // check that auction end is not before auction start
        if (auctionEnd < auctionStart) {
          alert("The Auction End date/time is before Auction Start date/time.");
          return false;
        }

        // check that ads start datetime is valid
        var adsStartValid = !isNaN(parseFloat(adsStart)) && isFinite(adsStart);
        if (adsStartValid === false) {
          alert("The Ads Start date/time is not valid.");
          return false;
        }

        // check that ads end datetime is valid
        var adsEndValid = !isNaN(parseFloat(adsEnd)) && isFinite(adsEnd);
        if (adsEndValid === false) {
          alert("The Ads End date/time is not valid.");
          return false;
        }

        // check that ads end is not before ads start
        if (adsEnd < adsStart) {
          alert("The Ads End date/time is before Ads Start date/time.");
          return false;
        }

        // check that ads Start is not before Auction end datetime
        if (adsStart < auctionEnd) {
          alert("The Ads Start date/time is before Auction End date/time.");
          return false;
        }

        // auction description
        var description = $('#auctionDescription').val();
        function urlX(url) { if(/^https?:\/\//.test(url)) { return url; }}
        function idX(id) { return id }
        var parsedHtml = html_sanitize(description, urlX, idX);

        return {
          auctionStart: auctionStart,
          auctionEnd: auctionEnd,
          adsStart: adsStart,
          adsEnd: adsEnd,
          description: parsedHtml
        };
      }

      function validateRegions(regions) {
        var valid = true;

        if (regions.length < 1) { valid = false; }

        if (valid === false) {
          alert('At least one region is required.');
        }

        return valid;
      }
    </script>
    <!-- endbower -->
    <!-- endbuild -->
</body>
</html>
