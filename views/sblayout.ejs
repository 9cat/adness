<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bitcoin Talk Ad Auction</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- build:css styles/vendor.css -->
    <!-- bower:css -->
    <link rel="stylesheet" href="/css/bootstrap/css/bootstrap.css" />
    <!-- endbower -->
    <!-- endbuild -->
    <!-- build:css({.tmp,app}) styles/main.css -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/datetimepicker/bootstrap-datetimepicker.css">
    <!-- endbuild -->
  </head>
  <body>
    <!--[if lt IE 7]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

    <!-- Page Start -->
    <div class="main">
      <!-- sidebar -->
      <div class="sidebar hidden-xs">
        <!-- Logo -->
        <div class="row logo">
          Adness
        </div>

        <!-- Links to other pages -->
        <% if (user && user.admin && user.admin === true) { %>
          <a href="/admin">
            <div class="sidebar-button">
              <span class="glyphicon glyphicon-wrench icon-large"></span><br>
              Admin
            </div>
          </a>
        <% } %>
        <a href="<%= browsePrefix %>">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-home icon-large"></span><br>
            Home
          </div>
        </a>
        <a href="<%= browsePrefix %>/rules">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-list-alt icon-large"></span><br>
            Rules
          </div>
        </a>
        <% if (user && user.username) { %>
          <a href="<%= browsePrefix %>/users/<%= user.userId %>">
            <div class="sidebar-button">
              <span class="glyphicon glyphicon-user icon-large"></span><br>
              Profile
            </div>
          </a>
        <% } %>
        <a href="<%= browsePrefix %>/history">
          <div class="sidebar-button">
            <span class="glyphicon glyphicon-bookmark icon-large"></span><br>
            History
          </div>
        </a>
      </div>

      <div class="main-container">
        <!-- mobile ready header -->
        <div class="row">
          <nav id="header" class="navbar navbar-default" role="navigation">
            <div class="container-fluid">

              <!-- Brand and toggle get grouped for better mobile display -->
              <div class="navbar-header">
                <% if (user) { %>
                  <div class="header-logout-message">
                    Logged In: <%= user.username %>
                  </div>
                <% } %>

                <!-- pull down login -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-login">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>

                <!-- drop down sidebar -->
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-sidenav" id="mobile-menu-btn">
                  Menu
                </button>
              </div>

              <!-- sidebar nav in header -->
              <div class="collapse" id="header-sidenav">
                <ul class="nav navbar-nav nav-justified">
                  <% if (user && user.admin && user.admin === true) { %>
                    <li><a href="/admin" class="navbar-link">Admin</a></li>
                  <% } %>
                  <li><a href="<%= browsePrefix %>" class="navbar-link">Home</a></li>
                  <li><a href="<%= browsePrefix %>/rules">Rules</a></li>
                  <% if (user && user.username) { %>
                    <li>
                      <a href="<%= browsePrefix %>/users/<%= user.userId %>">
                        Profile
                      </a>
                    </li>
                  <% } %>
                  <li><a href="<%= browsePrefix %>/history">History</a></li>
                </ul>
              </div><!-- /.navbar-collapse -->

              <!-- Collect the nav links, forms, and other content for toggling -->
              <div class="collapse navbar-collapse" id="header-login">
                <% if (user) { %>
                  <div class="header-logout-container-wide">
                    <a href="/logout" class="btn btn-primary">Logout</a>
                    <div class="header-logout-menu-message">
                      Logged In: <%= user.username %>
                    </div>
                  </div>
                <% } else { %>
                  <form class="form-inline" role="form" method="post" action="/login">
                    <div class="form-group">
                      <input name="username" type="username" class="form-control" placeholder="Username">
                    </div>
                    <div class="form-group">
                      <input name="password" type="password" class="form-control" placeholder="Password">
                    </div>
                    <button type="submit" class="btn btn-default">Log In</button>
                  </form>
                <% } %>
              </div><!-- /.navbar-collapse -->

            </div><!-- /.container-fluid -->
          </nav>
        </div>

        <!-- Main Content -->
        <div class="row">
          <%- body %>
        </div>
      </div>
    </div>

    <!-- Google Analytics: change UA-XXXXX-X to be your site's ID -->
    <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
       (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
       })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

       ga('create', 'UA-XXXXX-X');
       ga('send', 'pageview');
    </script>

    <!--[if lt IE 9]>
    <script src="bower_components/es5-shim/es5-shim.js"></script>
    <script src="bower_components/json3/lib/json3.min.js"></script>
    <![endif]-->

    <!-- build:js scripts/vendor.js -->
    <!-- bower:js -->
    <script src="/scripts/jquery/jquery-2.1.0.min.js"></script>
    <script src="/scripts/momentjs/moment.min.js"></script>
    <script src="/css/bootstrap/js/bootstrap.js"></script>
    <script src="/scripts/datetimepicker/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        // initialize the datetimepicker ui
        $('#startDateTime').datetimepicker({ useStrict: true });
        $('#endDateTime').datetimepicker({ useStrict: true });

        // set date time picker values
        if (document.URL.indexOf("/admin/auctions/edit") >= 0) {
          var start = $('#hiddenStart').val();
          var end = $('#hiddenEnd').val();
          setDateTime(start, end);
        }
        else if (document.URL.indexOf("/admin") >= 0) {
          setDateTime();
        }
      });

      function submitAuction(event) {
        // input validation
        var valid = auctionValidation();
        if(!valid) { return; }

        // ajax post call to server to create auction
        $.ajax({
          type: "POST",
          url: '<%= browsePrefix %>/auctions',
          data: {
            start: valid.start,
            end: valid.end,
            slots: valid.slots
          },
          success: function() {
            location.reload();
          },
          error: function() {
            alert("There was an error creating the auction.");
          }
        });
      }

      function updateAuction(id, enabled) {
        // input validation
        var valid = auctionValidation();
        if(!valid) { return; }

        var id = $('#auctionId').val();
        var enabled = $("#auctionEnabled").prop("checked");

        // ajax post call to server to create auction
        $.ajax({
          type: "POST",
          url: '<%= browsePrefix %>/auctions/edit',
          data: {
            auctionId: id,
            start: valid.start,
            end: valid.end,
            slots: valid.slots,
            enabled: enabled
          },
          success: function() {
            console.log(window.location);
            window.location.replace("http://" + window.location.host + "/admin");
          },
          error: function() {
            alert("There was an error updating the auction.");
          }
        });
      }

      function setDateTime(start, end) {
        if (start && end) {
          var newStart = new Date(Number(start));
          var momentStart = moment(newStart);
          $('#startDateTime').data('DateTimePicker').setDate(momentStart);

          var newEnd = new Date(Number(end));
          var momentEnd = moment(newEnd);
          $('#endDateTime').data('DateTimePicker').setDate(momentEnd);
        }
        else {
          // default date 
          // start is one day ahead midnight
          var defaultStart = new Date();
          defaultStart.setDate(defaultStart.getDate()+1);
          defaultStart.setHours(0);
          defaultStart.setMinutes(0);
          defaultStart.setSeconds(0);
          defaultStart.setMilliseconds(0);
          var momentStart = moment(defaultStart);
          $('#startDateTime').data('DateTimePicker').setDate(momentStart);

          // end is three days ahead midnight
          var defaultEnd = new Date();
          defaultEnd.setDate(defaultEnd.getDate() +3);
          defaultEnd.setHours(0);
          defaultEnd.setMinutes(0);
          defaultEnd.setSeconds(0);
          defaultEnd.setMilliseconds(0);
          var momentEnd = moment(defaultEnd);
          $('#endDateTime').data('DateTimePicker').setDate(momentEnd);
        }
      }

      function auctionValidation() {
        // Initial input validation
        var start;
        var startDate = $('#startDateTime').data('DateTimePicker').getDate();
        if (startDate) { start = startDate.valueOf(); }
        else { return alert("Start Date/Time doesn't look right."); }

        var end; 
        var endDate = $('#endDateTime').data('DateTimePicker').getDate();
        if (endDate) { end = endDate.valueOf(); }
        else { return alert("End Date/Time doesn't look right."); }

        var slots = $('#slots').val();

        // validate startDate, endDate and slots
        var startValid = !isNaN(parseFloat(start)) && isFinite(start);
        if (startValid === false) {
          alert("The Start date/time is not valid.");
          return false;
        }

        var endValid = !isNaN(parseFloat(end)) && isFinite(end);
        if (endValid === false) {
          alert("The End date/time is not valid.");
          return false;
        }

        if (end < start) {
          alert("The End date/time is before Start date/time.");
          return false;
        }

        var slotsValid = !isNaN(parseFloat(slots)) && isFinite(slots);
        if (slotsValid === false) {
          alert("The number of slots is not valid.");
          return false;
        }

        if (slots < 0) {
          alert("Slots Cannot be negative.");
          return false;
        }

        return {
          start: start,
          end: end,
          slots: slots
        };
      }

      // format all date strings in admin page
      $(document).ready(function() {
        $(".adminDate").each(function(index, value) {
          var dateString = $(value).text();
          var date = new Date(dateString).toLocaleString();
          $(value).text(date);
        })
      });
    </script>
    <!-- endbower -->
    <!-- endbuild -->
</body>
</html>
